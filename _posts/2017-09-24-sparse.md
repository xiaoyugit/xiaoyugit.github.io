
#### Introduction
Sparse matrix is everywhere when we deal with machine learning problem. But how is it different from a dense matrix on storage and operation? It seems that understand these things can help implement algorithms in a more efficient way.


```python
import numpy as np
import scipy.sparse as sp
```


```python
X=np.random.rand(1000,30)
C=np.random.rand(100,1000)
C[C<=0.95]=0
```


```python
C
```




    array([[ 0.,  0.,  0., ...,  0.,  0.,  0.],
           [ 0.,  0.,  0., ...,  0.,  0.,  0.],
           [ 0.,  0.,  0., ...,  0.,  0.,  0.],
           ..., 
           [ 0.,  0.,  0., ...,  0.,  0.,  0.],
           [ 0.,  0.,  0., ...,  0.,  0.,  0.],
           [ 0.,  0.,  0., ...,  0.,  0.,  0.]])



- Compressed Sparse Column matrix

the column indices is stored as an array and the row indices is compressed by ordering indptr

- Compressed Sparse Row matrix

the row indices is stored as an array and the column indices is compressed by ordering indptr

Let's demonstrate with csc below


```python
C = sp.csc_matrix(C)
C
```




    <100x1000 sparse matrix of type '<type 'numpy.float64'>'
    	with 4978 stored elements in Compressed Sparse Column format>




```python
print(C.data)
print(C.indices)
print(C.indptr)
```

    [ 0.96922918  0.99548937  0.99887233 ...,  0.97987386  0.96233273
      0.9729144 ]
    [ 6  9 25 ..., 72 75 91]
    [   0    5   10 ..., 4962 4969 4978]



```python
i = 1
```


```python
start_end_i = range(C.indptr[i], C.indptr[i+1])
```


```python
data = C.data[start_end_i]
col_idx = C.indices[start_end_i]
```


```python
print(data)
print(col_idx)
```

    [ 0.97634978  0.99774006  0.99185528  0.98969505  0.97923001]
    [32 36 43 58 87]



```python
C.getcol(i).nonzero()[0]
```




    array([32, 36, 43, 58, 87], dtype=int32)



It is improtant to choose appropriate compressed format for optimizing the operation efficiency. for example, csc perform way better than csr on column slicing.


```python
%timeit C.getcol(i)
```

    The slowest run took 8.66 times longer than the fastest. This could mean that an intermediate result is being cached.
    10000 loops, best of 3: 41.2 µs per loop



```python
C = C.tocsr()
%timeit C.getcol(i)
```

    10000 loops, best of 3: 47.9 µs per loop


#### A small test
Then the question is: for a given purpose, can we achieve best performance just by choosing the appropriate compressed format? 

Not really.

Recently I bumped into an algorithm that requires take each row out from a sparse matrix, turn it into a diagnal matrix, and perform some dot multiplication with a dense matrix.

Let's say, the dense matrix is $C$, while each submatrix we are going to construct is $C^u$ such that

$C^u_{ii}=c_{ui} $

For example, for row 1, in code, it is as below


```python
Cu=sp.diags(C.getrow(0).A, [0])
```


```python
(Cu.diagonal() == C[0,:]).all()
```




    True




```python
Cu
```




    <1000x1000 sparse matrix of type '<type 'numpy.float64'>'
    	with 1000 stored elements (1 diagonals) in DIAgonal format>



Suppose we want to calculate

$\sum_u X^T C^u X$

A naive implementation using scipy.sparse will be


```python
C=C.tocsc()
```


```python
def XCuT(X,C):
    out = np.zeros((X.shape[1],X.shape[1]))
    for i in range(C.shape[0]):
        Cu = sp.diags(C.getrow(i).A, [0])
        #print Cu.A.nonzero()
        out += X.T.dot(Cu.dot(X))
    return out
```


```python
%time XCuT(X,C)
```

    CPU times: user 198 ms, sys: 4.09 ms, total: 202 ms
    Wall time: 113 ms





    array([[ 1534.77677212,  1206.27224499,  1203.37793625,  1178.12667716,
             1185.27031179,  1165.46171895,  1127.68580982,  1204.79944403,
             1118.19326513,  1175.0454447 ,  1153.52893505,  1140.01620506,
             1177.23660914,  1108.34021112,  1158.45024637,  1178.47940173,
             1180.84475828,  1117.32994164,  1158.6563693 ,  1165.90335162,
             1111.04682641,  1182.06241081,  1179.11507784,  1186.5882038 ,
             1124.81492491,  1232.13702804,  1200.70898683,  1170.50788382,
             1167.29158678,  1136.35659346],
           [ 1206.27224499,  1663.08111076,  1261.13250903,  1241.57454674,
             1247.32797788,  1241.41525204,  1236.75971927,  1245.14541035,
             1214.52417533,  1235.98675446,  1237.79158819,  1204.91407264,
             1228.00307421,  1200.73989495,  1173.40470903,  1251.3419658 ,
             1248.64644785,  1193.04132139,  1225.2316204 ,  1226.51969842,
             1168.7405491 ,  1267.54964939,  1267.26905808,  1264.27205025,
             1205.41550058,  1309.55667533,  1270.77159966,  1202.15734741,
             1266.95394435,  1216.88333204],
           [ 1203.37793625,  1261.13250903,  1640.11916078,  1232.18625715,
             1240.37971936,  1221.584057  ,  1231.71166922,  1264.89701951,
             1210.06835204,  1219.76387592,  1181.8075972 ,  1223.98694021,
             1232.89516693,  1169.04379305,  1204.26697842,  1215.0953259 ,
             1227.57334274,  1189.26175423,  1221.25545344,  1219.51933967,
             1154.05043788,  1252.57088273,  1258.78124269,  1228.87737131,
             1192.2256763 ,  1277.26703382,  1238.17565966,  1232.94281438,
             1283.40863323,  1199.9894221 ],
           [ 1178.12667716,  1241.57454674,  1232.18625715,  1630.25724678,
             1229.45185626,  1210.529283  ,  1202.1996985 ,  1247.27535364,
             1207.88184489,  1214.54474111,  1221.2527798 ,  1186.29073922,
             1240.49194324,  1162.82863585,  1178.38034476,  1214.01322457,
             1210.56778128,  1146.62798815,  1214.31856076,  1205.94213669,
             1156.07223707,  1234.95665999,  1229.39891895,  1191.70102331,
             1188.22494391,  1293.58436531,  1280.45787693,  1196.40730042,
             1226.25608655,  1196.75358933],
           [ 1185.27031179,  1247.32797788,  1240.37971936,  1229.45185626,
             1669.90843693,  1243.78561182,  1209.50374137,  1255.92585943,
             1231.9776225 ,  1255.02703988,  1242.41701481,  1229.29826438,
             1251.15833646,  1192.06352452,  1201.64662379,  1262.47070482,
             1248.94755148,  1183.62385112,  1228.99926999,  1244.16738275,
             1179.47860863,  1260.32371065,  1293.41230285,  1237.09451362,
             1191.56742771,  1292.88521997,  1253.07688819,  1220.44175914,
             1227.82628354,  1225.02847095],
           [ 1165.46171895,  1241.41525204,  1221.584057  ,  1210.529283  ,
             1243.78561182,  1612.31595817,  1211.6348925 ,  1211.94057339,
             1211.19365373,  1198.98155437,  1193.0743571 ,  1178.84233411,
             1200.91861057,  1172.41802898,  1203.74649099,  1228.08087484,
             1205.3152383 ,  1194.28271808,  1239.46681486,  1196.75099974,
             1131.46165371,  1235.35645968,  1238.43605459,  1212.25740396,
             1193.37231024,  1273.45577204,  1217.29213904,  1185.87683993,
             1231.44638533,  1173.55901537],
           [ 1127.68580982,  1236.75971927,  1231.71166922,  1202.1996985 ,
             1209.50374137,  1211.6348925 ,  1605.51171999,  1230.17409144,
             1207.33864477,  1190.75492574,  1196.17661152,  1174.96356296,
             1220.0944372 ,  1172.17124364,  1190.8368653 ,  1184.94703366,
             1239.44169545,  1173.53675637,  1222.20649715,  1188.10210989,
             1152.24009128,  1235.74749808,  1233.46288957,  1200.99993113,
             1196.77441727,  1260.00830467,  1235.17462262,  1174.38950549,
             1242.66171648,  1195.93059211],
           [ 1204.79944403,  1245.14541035,  1264.89701951,  1247.27535364,
             1255.92585943,  1211.94057339,  1230.17409144,  1644.79235821,
             1213.57719294,  1247.32529645,  1234.47054774,  1207.80785383,
             1219.56714929,  1185.53139531,  1223.11946756,  1227.15401762,
             1244.20207257,  1210.18427578,  1263.35646654,  1209.80787795,
             1178.05729976,  1248.35206815,  1251.57016255,  1221.46528492,
             1224.008806  ,  1283.41974846,  1265.13643742,  1237.93468315,
             1266.34059712,  1235.4288169 ],
           [ 1118.19326513,  1214.52417533,  1210.06835204,  1207.88184489,
             1231.9776225 ,  1211.19365373,  1207.33864477,  1213.57719294,
             1583.52221608,  1213.22514672,  1182.64975547,  1190.85104395,
             1211.01471795,  1163.36799279,  1171.04588751,  1234.14138648,
             1183.98245885,  1132.99045996,  1211.4003593 ,  1180.08789041,
             1123.60334779,  1224.74194   ,  1214.88556586,  1188.8362223 ,
             1187.96528774,  1272.6822504 ,  1216.17580313,  1175.33671491,
             1209.38219915,  1194.10174614],
           [ 1175.0454447 ,  1235.98675446,  1219.76387592,  1214.54474111,
             1255.02703988,  1198.98155437,  1190.75492574,  1247.32529645,
             1213.22514672,  1632.16147076,  1221.01027457,  1188.09435467,
             1259.83776512,  1180.45661936,  1172.36762276,  1224.58200242,
             1221.8530523 ,  1177.32370262,  1251.81261714,  1226.12825359,
             1120.28904678,  1245.07208412,  1242.1083592 ,  1172.45352415,
             1173.42259898,  1255.24501864,  1231.91156395,  1204.90431373,
             1218.13338232,  1203.34922193],
           [ 1153.52893505,  1237.79158819,  1181.8075972 ,  1221.2527798 ,
             1242.41701481,  1193.0743571 ,  1196.17661152,  1234.47054774,
             1182.64975547,  1221.01027457,  1617.21347309,  1187.38761582,
             1223.36558538,  1147.85982435,  1181.56630363,  1209.86759599,
             1232.63958615,  1177.9282445 ,  1192.07031774,  1207.71849145,
             1137.00642062,  1234.96182989,  1234.28795595,  1197.90002138,
             1197.15728272,  1244.55410841,  1245.54342196,  1204.13571429,
             1220.11758408,  1183.65082235],
           [ 1140.01620506,  1204.91407264,  1223.98694021,  1186.29073922,
             1229.29826438,  1178.84233411,  1174.96356296,  1207.80785383,
             1190.85104395,  1188.09435467,  1187.38761582,  1566.60329056,
             1203.54390476,  1133.74487413,  1166.74317809,  1192.50665184,
             1169.10111096,  1136.20449274,  1177.56646587,  1178.56133179,
             1119.4832797 ,  1209.71802293,  1211.45196452,  1220.30695717,
             1162.42859333,  1246.8593764 ,  1241.92220457,  1202.82092984,
             1211.96786603,  1181.58417515],
           [ 1177.23660914,  1228.00307421,  1232.89516693,  1240.49194324,
             1251.15833646,  1200.91861057,  1220.0944372 ,  1219.56714929,
             1211.01471795,  1259.83776512,  1223.36558538,  1203.54390476,
             1638.61966196,  1169.99238203,  1206.9626948 ,  1226.54346676,
             1237.64623756,  1170.69695182,  1262.47210335,  1224.64589306,
             1146.42978524,  1247.43709595,  1251.54676811,  1214.23021694,
             1195.09314606,  1323.34339377,  1221.66968564,  1196.14042322,
             1248.64403372,  1183.95142133],
           [ 1108.34021112,  1200.73989495,  1169.04379305,  1162.82863585,
             1192.06352452,  1172.41802898,  1172.17124364,  1185.53139531,
             1163.36799279,  1180.45661936,  1147.85982435,  1133.74487413,
             1169.99238203,  1511.00187671,  1099.32662991,  1156.38197978,
             1172.83312885,  1079.68775669,  1167.08795139,  1149.7614664 ,
             1092.96874696,  1162.87302407,  1213.59876793,  1155.4796614 ,
             1140.17828444,  1211.0200005 ,  1196.45680035,  1166.25564908,
             1174.34468567,  1108.20865985],
           [ 1158.45024637,  1173.40470903,  1204.26697842,  1178.38034476,
             1201.64662379,  1203.74649099,  1190.8368653 ,  1223.11946756,
             1171.04588751,  1172.36762276,  1181.56630363,  1166.74317809,
             1206.9626948 ,  1099.32662991,  1556.37962007,  1183.3299531 ,
             1148.07713441,  1130.61236048,  1206.99015673,  1182.37764751,
             1100.43284576,  1199.68852761,  1191.31914146,  1189.73243263,
             1140.39260393,  1239.07513913,  1187.87162667,  1196.81461571,
             1198.92531543,  1157.8146057 ],
           [ 1178.47940173,  1251.3419658 ,  1215.0953259 ,  1214.01322457,
             1262.47070482,  1228.08087484,  1184.94703366,  1227.15401762,
             1234.14138648,  1224.58200242,  1209.86759599,  1192.50665184,
             1226.54346676,  1156.38197978,  1183.3299531 ,  1638.4700515 ,
             1237.26665527,  1177.51231521,  1222.44205671,  1228.70512456,
             1166.3591787 ,  1239.92525012,  1217.09770724,  1244.70135436,
             1172.83026884,  1285.32125502,  1232.02281673,  1177.91040855,
             1196.68599994,  1203.73046527],
           [ 1180.84475828,  1248.64644785,  1227.57334274,  1210.56778128,
             1248.94755148,  1205.3152383 ,  1239.44169545,  1244.20207257,
             1183.98245885,  1221.8530523 ,  1232.63958615,  1169.10111096,
             1237.64623756,  1172.83312885,  1148.07713441,  1237.26665527,
             1630.82193444,  1176.99198594,  1208.17457387,  1196.65390013,
             1154.58655537,  1225.95193653,  1231.84415945,  1186.16212754,
             1184.96716454,  1290.0660252 ,  1225.20006845,  1196.10630382,
             1236.2672747 ,  1198.0796835 ],
           [ 1117.32994164,  1193.04132139,  1189.26175423,  1146.62798815,
             1183.62385112,  1194.28271808,  1173.53675637,  1210.18427578,
             1132.99045996,  1177.32370262,  1177.9282445 ,  1136.20449274,
             1170.69695182,  1079.68775669,  1130.61236048,  1177.51231521,
             1176.99198594,  1570.18242059,  1177.90172038,  1178.42522459,
             1115.34253616,  1198.48970081,  1191.89376104,  1186.03958942,
             1162.95705687,  1232.88392872,  1156.82955239,  1150.7095488 ,
             1203.15428622,  1151.88625661],
           [ 1158.6563693 ,  1225.2316204 ,  1221.25545344,  1214.31856076,
             1228.99926999,  1239.46681486,  1222.20649715,  1263.35646654,
             1211.4003593 ,  1251.81261714,  1192.07031774,  1177.56646587,
             1262.47210335,  1167.08795139,  1206.99015673,  1222.44205671,
             1208.17457387,  1177.90172038,  1609.97150023,  1215.23486958,
             1132.84836517,  1236.5483741 ,  1249.84530462,  1214.08307236,
             1191.45609805,  1285.24073738,  1236.70272056,  1204.24762432,
             1223.89568206,  1195.54425883],
           [ 1165.90335162,  1226.51969842,  1219.51933967,  1205.94213669,
             1244.16738275,  1196.75099974,  1188.10210989,  1209.80787795,
             1180.08789041,  1226.12825359,  1207.71849145,  1178.56133179,
             1224.64589306,  1149.7614664 ,  1182.37764751,  1228.70512456,
             1196.65390013,  1178.42522459,  1215.23486958,  1601.90066055,
             1133.91610718,  1243.77071008,  1215.14946867,  1223.16047297,
             1186.15339009,  1284.64073262,  1209.31193233,  1177.34144926,
             1210.91613415,  1181.58974308],
           [ 1111.04682641,  1168.7405491 ,  1154.05043788,  1156.07223707,
             1179.47860863,  1131.46165371,  1152.24009128,  1178.05729976,
             1123.60334779,  1120.28904678,  1137.00642062,  1119.4832797 ,
             1146.42978524,  1092.96874696,  1100.43284576,  1166.3591787 ,
             1154.58655537,  1115.34253616,  1132.84836517,  1133.91610718,
             1479.27084101,  1163.58716365,  1171.34076686,  1148.67125772,
             1115.70188855,  1208.14962095,  1173.54797217,  1109.52342266,
             1158.0166878 ,  1138.22671149],
           [ 1182.06241081,  1267.54964939,  1252.57088273,  1234.95665999,
             1260.32371065,  1235.35645968,  1235.74749808,  1248.35206815,
             1224.74194   ,  1245.07208412,  1234.96182989,  1209.71802293,
             1247.43709595,  1162.87302407,  1199.68852761,  1239.92525012,
             1225.95193653,  1198.48970081,  1236.5483741 ,  1243.77071008,
             1163.58716365,  1668.62196784,  1228.01941468,  1231.14365657,
             1232.16980009,  1314.8769223 ,  1241.25161244,  1202.720875  ,
             1259.75034655,  1207.58024612],
           [ 1179.11507784,  1267.26905808,  1258.78124269,  1229.39891895,
             1293.41230285,  1238.43605459,  1233.46288957,  1251.57016255,
             1214.88556586,  1242.1083592 ,  1234.28795595,  1211.45196452,
             1251.54676811,  1213.59876793,  1191.31914146,  1217.09770724,
             1231.84415945,  1191.89376104,  1249.84530462,  1215.14946867,
             1171.34076686,  1228.01941468,  1657.01015408,  1239.68999975,
             1204.89128629,  1289.63658677,  1231.8333841 ,  1209.61365367,
             1276.33695672,  1217.5620523 ],
           [ 1186.5882038 ,  1264.27205025,  1228.87737131,  1191.70102331,
             1237.09451362,  1212.25740396,  1200.99993113,  1221.46528492,
             1188.8362223 ,  1172.45352415,  1197.90002138,  1220.30695717,
             1214.23021694,  1155.4796614 ,  1189.73243263,  1244.70135436,
             1186.16212754,  1186.03958942,  1214.08307236,  1223.16047297,
             1148.67125772,  1231.14365657,  1239.68999975,  1615.29327661,
             1197.87108525,  1263.23527111,  1241.65441066,  1202.19945874,
             1220.09397183,  1178.24766112],
           [ 1124.81492491,  1205.41550058,  1192.2256763 ,  1188.22494391,
             1191.56742771,  1193.37231024,  1196.77441727,  1224.008806  ,
             1187.96528774,  1173.42259898,  1197.15728272,  1162.42859333,
             1195.09314606,  1140.17828444,  1140.39260393,  1172.83026884,
             1184.96716454,  1162.95705687,  1191.45609805,  1186.15339009,
             1115.70188855,  1232.16980009,  1204.89128629,  1197.87108525,
             1571.33579662,  1252.85203409,  1194.38337052,  1141.02729223,
             1198.93675132,  1201.09925813],
           [ 1232.13702804,  1309.55667533,  1277.26703382,  1293.58436531,
             1292.88521997,  1273.45577204,  1260.00830467,  1283.41974846,
             1272.6822504 ,  1255.24501864,  1244.55410841,  1246.8593764 ,
             1323.34339377,  1211.0200005 ,  1239.07513913,  1285.32125502,
             1290.0660252 ,  1232.88392872,  1285.24073738,  1284.64073262,
             1208.14962095,  1314.8769223 ,  1289.63658677,  1263.23527111,
             1252.85203409,  1743.61879351,  1303.35345326,  1250.41296393,
             1312.04066001,  1235.50195513],
           [ 1200.70898683,  1270.77159966,  1238.17565966,  1280.45787693,
             1253.07688819,  1217.29213904,  1235.17462262,  1265.13643742,
             1216.17580313,  1231.91156395,  1245.54342196,  1241.92220457,
             1221.66968564,  1196.45680035,  1187.87162667,  1232.02281673,
             1225.20006845,  1156.82955239,  1236.70272056,  1209.31193233,
             1173.54797217,  1241.25161244,  1231.8333841 ,  1241.65441066,
             1194.38337052,  1303.35345326,  1646.74567868,  1227.47240565,
             1228.71696402,  1214.75058263],
           [ 1170.50788382,  1202.15734741,  1232.94281438,  1196.40730042,
             1220.44175914,  1185.87683993,  1174.38950549,  1237.93468315,
             1175.33671491,  1204.90431373,  1204.13571429,  1202.82092984,
             1196.14042322,  1166.25564908,  1196.81461571,  1177.91040855,
             1196.10630382,  1150.7095488 ,  1204.24762432,  1177.34144926,
             1109.52342266,  1202.720875  ,  1209.61365367,  1202.19945874,
             1141.02729223,  1250.41296393,  1227.47240565,  1564.95389971,
             1225.7703704 ,  1157.25671899],
           [ 1167.29158678,  1266.95394435,  1283.40863323,  1226.25608655,
             1227.82628354,  1231.44638533,  1242.66171648,  1266.34059712,
             1209.38219915,  1218.13338232,  1220.11758408,  1211.96786603,
             1248.64403372,  1174.34468567,  1198.92531543,  1196.68599994,
             1236.2672747 ,  1203.15428622,  1223.89568206,  1210.91613415,
             1158.0166878 ,  1259.75034655,  1276.33695672,  1220.09397183,
             1198.93675132,  1312.04066001,  1228.71696402,  1225.7703704 ,
             1657.34270043,  1208.60167501],
           [ 1136.35659346,  1216.88333204,  1199.9894221 ,  1196.75358933,
             1225.02847095,  1173.55901537,  1195.93059211,  1235.4288169 ,
             1194.10174614,  1203.34922193,  1183.65082235,  1181.58417515,
             1183.95142133,  1108.20865985,  1157.8146057 ,  1203.73046527,
             1198.0796835 ,  1151.88625661,  1195.54425883,  1181.58974308,
             1138.22671149,  1207.58024612,  1217.5620523 ,  1178.24766112,
             1201.09925813,  1235.50195513,  1214.75058263,  1157.25671899,
             1208.60167501,  1566.73394815]])



But actually the construction of $C_u$ at each iteration is unnecessary


```python
def XCuT_fast(X,C):
    out = np.zeros((X.shape[1],X.shape[1]))
    C=C.tocsr()
    data, indices, indptr = C.data, C.indices, C.indptr
    for i in range(C.shape[0]):
        Cu, mask = data[indptr[i]:indptr[i+1]], indices[indptr[i]:indptr[i+1]]
        #print(mask)
        X_mask = X[mask, :]
        Cu = Cu[: ,None]
        out += X_mask.T.dot(Cu * X_mask)
    return out
```


```python
%time XCuT_fast(X,C)
```

    CPU times: user 9.35 ms, sys: 1.43 ms, total: 10.8 ms
    Wall time: 5.57 ms





    array([[ 1534.77677212,  1206.27224499,  1203.37793625,  1178.12667716,
             1185.27031179,  1165.46171895,  1127.68580982,  1204.79944403,
             1118.19326513,  1175.0454447 ,  1153.52893505,  1140.01620506,
             1177.23660914,  1108.34021112,  1158.45024637,  1178.47940173,
             1180.84475828,  1117.32994164,  1158.6563693 ,  1165.90335162,
             1111.04682641,  1182.06241081,  1179.11507784,  1186.5882038 ,
             1124.81492491,  1232.13702804,  1200.70898683,  1170.50788382,
             1167.29158678,  1136.35659346],
           [ 1206.27224499,  1663.08111076,  1261.13250903,  1241.57454674,
             1247.32797788,  1241.41525204,  1236.75971927,  1245.14541035,
             1214.52417533,  1235.98675446,  1237.79158819,  1204.91407264,
             1228.00307421,  1200.73989495,  1173.40470903,  1251.3419658 ,
             1248.64644785,  1193.04132139,  1225.2316204 ,  1226.51969842,
             1168.7405491 ,  1267.54964939,  1267.26905808,  1264.27205025,
             1205.41550058,  1309.55667533,  1270.77159966,  1202.15734741,
             1266.95394435,  1216.88333204],
           [ 1203.37793625,  1261.13250903,  1640.11916078,  1232.18625715,
             1240.37971936,  1221.584057  ,  1231.71166922,  1264.89701951,
             1210.06835204,  1219.76387592,  1181.8075972 ,  1223.98694021,
             1232.89516693,  1169.04379305,  1204.26697842,  1215.0953259 ,
             1227.57334274,  1189.26175423,  1221.25545344,  1219.51933967,
             1154.05043788,  1252.57088273,  1258.78124269,  1228.87737131,
             1192.2256763 ,  1277.26703382,  1238.17565966,  1232.94281438,
             1283.40863323,  1199.9894221 ],
           [ 1178.12667716,  1241.57454674,  1232.18625715,  1630.25724678,
             1229.45185626,  1210.529283  ,  1202.1996985 ,  1247.27535364,
             1207.88184489,  1214.54474111,  1221.2527798 ,  1186.29073922,
             1240.49194324,  1162.82863585,  1178.38034476,  1214.01322457,
             1210.56778128,  1146.62798815,  1214.31856076,  1205.94213669,
             1156.07223707,  1234.95665999,  1229.39891895,  1191.70102331,
             1188.22494391,  1293.58436531,  1280.45787693,  1196.40730042,
             1226.25608655,  1196.75358933],
           [ 1185.27031179,  1247.32797788,  1240.37971936,  1229.45185626,
             1669.90843693,  1243.78561182,  1209.50374137,  1255.92585943,
             1231.9776225 ,  1255.02703988,  1242.41701481,  1229.29826438,
             1251.15833646,  1192.06352452,  1201.64662379,  1262.47070482,
             1248.94755148,  1183.62385112,  1228.99926999,  1244.16738275,
             1179.47860863,  1260.32371065,  1293.41230285,  1237.09451362,
             1191.56742771,  1292.88521997,  1253.07688819,  1220.44175914,
             1227.82628354,  1225.02847095],
           [ 1165.46171895,  1241.41525204,  1221.584057  ,  1210.529283  ,
             1243.78561182,  1612.31595817,  1211.6348925 ,  1211.94057339,
             1211.19365373,  1198.98155437,  1193.0743571 ,  1178.84233411,
             1200.91861057,  1172.41802898,  1203.74649099,  1228.08087484,
             1205.3152383 ,  1194.28271808,  1239.46681486,  1196.75099974,
             1131.46165371,  1235.35645968,  1238.43605459,  1212.25740396,
             1193.37231024,  1273.45577204,  1217.29213904,  1185.87683993,
             1231.44638533,  1173.55901537],
           [ 1127.68580982,  1236.75971927,  1231.71166922,  1202.1996985 ,
             1209.50374137,  1211.6348925 ,  1605.51171999,  1230.17409144,
             1207.33864477,  1190.75492574,  1196.17661152,  1174.96356296,
             1220.0944372 ,  1172.17124364,  1190.8368653 ,  1184.94703366,
             1239.44169545,  1173.53675637,  1222.20649715,  1188.10210989,
             1152.24009128,  1235.74749808,  1233.46288957,  1200.99993113,
             1196.77441727,  1260.00830467,  1235.17462262,  1174.38950549,
             1242.66171648,  1195.93059211],
           [ 1204.79944403,  1245.14541035,  1264.89701951,  1247.27535364,
             1255.92585943,  1211.94057339,  1230.17409144,  1644.79235821,
             1213.57719294,  1247.32529645,  1234.47054774,  1207.80785383,
             1219.56714929,  1185.53139531,  1223.11946756,  1227.15401762,
             1244.20207257,  1210.18427578,  1263.35646654,  1209.80787795,
             1178.05729976,  1248.35206815,  1251.57016255,  1221.46528492,
             1224.008806  ,  1283.41974846,  1265.13643742,  1237.93468315,
             1266.34059712,  1235.4288169 ],
           [ 1118.19326513,  1214.52417533,  1210.06835204,  1207.88184489,
             1231.9776225 ,  1211.19365373,  1207.33864477,  1213.57719294,
             1583.52221608,  1213.22514672,  1182.64975547,  1190.85104395,
             1211.01471795,  1163.36799279,  1171.04588751,  1234.14138648,
             1183.98245885,  1132.99045996,  1211.4003593 ,  1180.08789041,
             1123.60334779,  1224.74194   ,  1214.88556586,  1188.8362223 ,
             1187.96528774,  1272.6822504 ,  1216.17580313,  1175.33671491,
             1209.38219915,  1194.10174614],
           [ 1175.0454447 ,  1235.98675446,  1219.76387592,  1214.54474111,
             1255.02703988,  1198.98155437,  1190.75492574,  1247.32529645,
             1213.22514672,  1632.16147076,  1221.01027457,  1188.09435467,
             1259.83776512,  1180.45661936,  1172.36762276,  1224.58200242,
             1221.8530523 ,  1177.32370262,  1251.81261714,  1226.12825359,
             1120.28904678,  1245.07208412,  1242.1083592 ,  1172.45352415,
             1173.42259898,  1255.24501864,  1231.91156395,  1204.90431373,
             1218.13338232,  1203.34922193],
           [ 1153.52893505,  1237.79158819,  1181.8075972 ,  1221.2527798 ,
             1242.41701481,  1193.0743571 ,  1196.17661152,  1234.47054774,
             1182.64975547,  1221.01027457,  1617.21347309,  1187.38761582,
             1223.36558538,  1147.85982435,  1181.56630363,  1209.86759599,
             1232.63958615,  1177.9282445 ,  1192.07031774,  1207.71849145,
             1137.00642062,  1234.96182989,  1234.28795595,  1197.90002138,
             1197.15728272,  1244.55410841,  1245.54342196,  1204.13571429,
             1220.11758408,  1183.65082235],
           [ 1140.01620506,  1204.91407264,  1223.98694021,  1186.29073922,
             1229.29826438,  1178.84233411,  1174.96356296,  1207.80785383,
             1190.85104395,  1188.09435467,  1187.38761582,  1566.60329056,
             1203.54390476,  1133.74487413,  1166.74317809,  1192.50665184,
             1169.10111096,  1136.20449274,  1177.56646587,  1178.56133179,
             1119.4832797 ,  1209.71802293,  1211.45196452,  1220.30695717,
             1162.42859333,  1246.8593764 ,  1241.92220457,  1202.82092984,
             1211.96786603,  1181.58417515],
           [ 1177.23660914,  1228.00307421,  1232.89516693,  1240.49194324,
             1251.15833646,  1200.91861057,  1220.0944372 ,  1219.56714929,
             1211.01471795,  1259.83776512,  1223.36558538,  1203.54390476,
             1638.61966196,  1169.99238203,  1206.9626948 ,  1226.54346676,
             1237.64623756,  1170.69695182,  1262.47210335,  1224.64589306,
             1146.42978524,  1247.43709595,  1251.54676811,  1214.23021694,
             1195.09314606,  1323.34339377,  1221.66968564,  1196.14042322,
             1248.64403372,  1183.95142133],
           [ 1108.34021112,  1200.73989495,  1169.04379305,  1162.82863585,
             1192.06352452,  1172.41802898,  1172.17124364,  1185.53139531,
             1163.36799279,  1180.45661936,  1147.85982435,  1133.74487413,
             1169.99238203,  1511.00187671,  1099.32662991,  1156.38197978,
             1172.83312885,  1079.68775669,  1167.08795139,  1149.7614664 ,
             1092.96874696,  1162.87302407,  1213.59876793,  1155.4796614 ,
             1140.17828444,  1211.0200005 ,  1196.45680035,  1166.25564908,
             1174.34468567,  1108.20865985],
           [ 1158.45024637,  1173.40470903,  1204.26697842,  1178.38034476,
             1201.64662379,  1203.74649099,  1190.8368653 ,  1223.11946756,
             1171.04588751,  1172.36762276,  1181.56630363,  1166.74317809,
             1206.9626948 ,  1099.32662991,  1556.37962007,  1183.3299531 ,
             1148.07713441,  1130.61236048,  1206.99015673,  1182.37764751,
             1100.43284576,  1199.68852761,  1191.31914146,  1189.73243263,
             1140.39260393,  1239.07513913,  1187.87162667,  1196.81461571,
             1198.92531543,  1157.8146057 ],
           [ 1178.47940173,  1251.3419658 ,  1215.0953259 ,  1214.01322457,
             1262.47070482,  1228.08087484,  1184.94703366,  1227.15401762,
             1234.14138648,  1224.58200242,  1209.86759599,  1192.50665184,
             1226.54346676,  1156.38197978,  1183.3299531 ,  1638.4700515 ,
             1237.26665527,  1177.51231521,  1222.44205671,  1228.70512456,
             1166.3591787 ,  1239.92525012,  1217.09770724,  1244.70135436,
             1172.83026884,  1285.32125502,  1232.02281673,  1177.91040855,
             1196.68599994,  1203.73046527],
           [ 1180.84475828,  1248.64644785,  1227.57334274,  1210.56778128,
             1248.94755148,  1205.3152383 ,  1239.44169545,  1244.20207257,
             1183.98245885,  1221.8530523 ,  1232.63958615,  1169.10111096,
             1237.64623756,  1172.83312885,  1148.07713441,  1237.26665527,
             1630.82193444,  1176.99198594,  1208.17457387,  1196.65390013,
             1154.58655537,  1225.95193653,  1231.84415945,  1186.16212754,
             1184.96716454,  1290.0660252 ,  1225.20006845,  1196.10630382,
             1236.2672747 ,  1198.0796835 ],
           [ 1117.32994164,  1193.04132139,  1189.26175423,  1146.62798815,
             1183.62385112,  1194.28271808,  1173.53675637,  1210.18427578,
             1132.99045996,  1177.32370262,  1177.9282445 ,  1136.20449274,
             1170.69695182,  1079.68775669,  1130.61236048,  1177.51231521,
             1176.99198594,  1570.18242059,  1177.90172038,  1178.42522459,
             1115.34253616,  1198.48970081,  1191.89376104,  1186.03958942,
             1162.95705687,  1232.88392872,  1156.82955239,  1150.7095488 ,
             1203.15428622,  1151.88625661],
           [ 1158.6563693 ,  1225.2316204 ,  1221.25545344,  1214.31856076,
             1228.99926999,  1239.46681486,  1222.20649715,  1263.35646654,
             1211.4003593 ,  1251.81261714,  1192.07031774,  1177.56646587,
             1262.47210335,  1167.08795139,  1206.99015673,  1222.44205671,
             1208.17457387,  1177.90172038,  1609.97150023,  1215.23486958,
             1132.84836517,  1236.5483741 ,  1249.84530462,  1214.08307236,
             1191.45609805,  1285.24073738,  1236.70272056,  1204.24762432,
             1223.89568206,  1195.54425883],
           [ 1165.90335162,  1226.51969842,  1219.51933967,  1205.94213669,
             1244.16738275,  1196.75099974,  1188.10210989,  1209.80787795,
             1180.08789041,  1226.12825359,  1207.71849145,  1178.56133179,
             1224.64589306,  1149.7614664 ,  1182.37764751,  1228.70512456,
             1196.65390013,  1178.42522459,  1215.23486958,  1601.90066055,
             1133.91610718,  1243.77071008,  1215.14946867,  1223.16047297,
             1186.15339009,  1284.64073262,  1209.31193233,  1177.34144926,
             1210.91613415,  1181.58974308],
           [ 1111.04682641,  1168.7405491 ,  1154.05043788,  1156.07223707,
             1179.47860863,  1131.46165371,  1152.24009128,  1178.05729976,
             1123.60334779,  1120.28904678,  1137.00642062,  1119.4832797 ,
             1146.42978524,  1092.96874696,  1100.43284576,  1166.3591787 ,
             1154.58655537,  1115.34253616,  1132.84836517,  1133.91610718,
             1479.27084101,  1163.58716365,  1171.34076686,  1148.67125772,
             1115.70188855,  1208.14962095,  1173.54797217,  1109.52342266,
             1158.0166878 ,  1138.22671149],
           [ 1182.06241081,  1267.54964939,  1252.57088273,  1234.95665999,
             1260.32371065,  1235.35645968,  1235.74749808,  1248.35206815,
             1224.74194   ,  1245.07208412,  1234.96182989,  1209.71802293,
             1247.43709595,  1162.87302407,  1199.68852761,  1239.92525012,
             1225.95193653,  1198.48970081,  1236.5483741 ,  1243.77071008,
             1163.58716365,  1668.62196784,  1228.01941468,  1231.14365657,
             1232.16980009,  1314.8769223 ,  1241.25161244,  1202.720875  ,
             1259.75034655,  1207.58024612],
           [ 1179.11507784,  1267.26905808,  1258.78124269,  1229.39891895,
             1293.41230285,  1238.43605459,  1233.46288957,  1251.57016255,
             1214.88556586,  1242.1083592 ,  1234.28795595,  1211.45196452,
             1251.54676811,  1213.59876793,  1191.31914146,  1217.09770724,
             1231.84415945,  1191.89376104,  1249.84530462,  1215.14946867,
             1171.34076686,  1228.01941468,  1657.01015408,  1239.68999975,
             1204.89128629,  1289.63658677,  1231.8333841 ,  1209.61365367,
             1276.33695672,  1217.5620523 ],
           [ 1186.5882038 ,  1264.27205025,  1228.87737131,  1191.70102331,
             1237.09451362,  1212.25740396,  1200.99993113,  1221.46528492,
             1188.8362223 ,  1172.45352415,  1197.90002138,  1220.30695717,
             1214.23021694,  1155.4796614 ,  1189.73243263,  1244.70135436,
             1186.16212754,  1186.03958942,  1214.08307236,  1223.16047297,
             1148.67125772,  1231.14365657,  1239.68999975,  1615.29327661,
             1197.87108525,  1263.23527111,  1241.65441066,  1202.19945874,
             1220.09397183,  1178.24766112],
           [ 1124.81492491,  1205.41550058,  1192.2256763 ,  1188.22494391,
             1191.56742771,  1193.37231024,  1196.77441727,  1224.008806  ,
             1187.96528774,  1173.42259898,  1197.15728272,  1162.42859333,
             1195.09314606,  1140.17828444,  1140.39260393,  1172.83026884,
             1184.96716454,  1162.95705687,  1191.45609805,  1186.15339009,
             1115.70188855,  1232.16980009,  1204.89128629,  1197.87108525,
             1571.33579662,  1252.85203409,  1194.38337052,  1141.02729223,
             1198.93675132,  1201.09925813],
           [ 1232.13702804,  1309.55667533,  1277.26703382,  1293.58436531,
             1292.88521997,  1273.45577204,  1260.00830467,  1283.41974846,
             1272.6822504 ,  1255.24501864,  1244.55410841,  1246.8593764 ,
             1323.34339377,  1211.0200005 ,  1239.07513913,  1285.32125502,
             1290.0660252 ,  1232.88392872,  1285.24073738,  1284.64073262,
             1208.14962095,  1314.8769223 ,  1289.63658677,  1263.23527111,
             1252.85203409,  1743.61879351,  1303.35345326,  1250.41296393,
             1312.04066001,  1235.50195513],
           [ 1200.70898683,  1270.77159966,  1238.17565966,  1280.45787693,
             1253.07688819,  1217.29213904,  1235.17462262,  1265.13643742,
             1216.17580313,  1231.91156395,  1245.54342196,  1241.92220457,
             1221.66968564,  1196.45680035,  1187.87162667,  1232.02281673,
             1225.20006845,  1156.82955239,  1236.70272056,  1209.31193233,
             1173.54797217,  1241.25161244,  1231.8333841 ,  1241.65441066,
             1194.38337052,  1303.35345326,  1646.74567868,  1227.47240565,
             1228.71696402,  1214.75058263],
           [ 1170.50788382,  1202.15734741,  1232.94281438,  1196.40730042,
             1220.44175914,  1185.87683993,  1174.38950549,  1237.93468315,
             1175.33671491,  1204.90431373,  1204.13571429,  1202.82092984,
             1196.14042322,  1166.25564908,  1196.81461571,  1177.91040855,
             1196.10630382,  1150.7095488 ,  1204.24762432,  1177.34144926,
             1109.52342266,  1202.720875  ,  1209.61365367,  1202.19945874,
             1141.02729223,  1250.41296393,  1227.47240565,  1564.95389971,
             1225.7703704 ,  1157.25671899],
           [ 1167.29158678,  1266.95394435,  1283.40863323,  1226.25608655,
             1227.82628354,  1231.44638533,  1242.66171648,  1266.34059712,
             1209.38219915,  1218.13338232,  1220.11758408,  1211.96786603,
             1248.64403372,  1174.34468567,  1198.92531543,  1196.68599994,
             1236.2672747 ,  1203.15428622,  1223.89568206,  1210.91613415,
             1158.0166878 ,  1259.75034655,  1276.33695672,  1220.09397183,
             1198.93675132,  1312.04066001,  1228.71696402,  1225.7703704 ,
             1657.34270043,  1208.60167501],
           [ 1136.35659346,  1216.88333204,  1199.9894221 ,  1196.75358933,
             1225.02847095,  1173.55901537,  1195.93059211,  1235.4288169 ,
             1194.10174614,  1203.34922193,  1183.65082235,  1181.58417515,
             1183.95142133,  1108.20865985,  1157.8146057 ,  1203.73046527,
             1198.0796835 ,  1151.88625661,  1195.54425883,  1181.58974308,
             1138.22671149,  1207.58024612,  1217.5620523 ,  1178.24766112,
             1201.09925813,  1235.50195513,  1214.75058263,  1157.25671899,
             1208.60167501,  1566.73394815]])




```python
(XCuT(X,C) - XCuT_fast(X,C)).sum()
```




    1.2960299500264227e-11



#### 20x faster
